using Loqui;
using Loqui.Generation;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Mutagen.Bethesda.Generation
{
    public class ObservableModModule : GenerationModule
    {
        public override async Task MiscellaneousGenerationActions(ObjectGeneration obj)
        {
            if (obj.GetObjectType() != ObjectType.Mod) return;
            FileGeneration fg = new FileGeneration();
            AddUsings(fg);
            fg.AppendLine($"namespace {obj.Namespace}");
            using (new BraceWrapper(fg))
            {
                fg.AppendLine($"public partial class {obj.Name}_Observable : ObservableModBase");
                using (new BraceWrapper(fg))
                {
                    await GenerateMembers(obj, fg);
                    GenerateCtor(obj, fg);
                    await GenerateInit(obj, fg);
                    GenerateWhere(obj, fg);
                    GenerateDo(obj, fg);
                    GenerateWrite(obj, fg);
                }
            }

            var fileName = Path.Combine(obj.TargetDir.FullName, $"{obj.Name}_Observable_{ObjectGeneration.AUTOGENERATED}.cs");
            fg.Generate(fileName);
            obj.ProtoGen.GeneratedFiles[fileName] = ProjItemType.Compile;
        }

        private static void GenerateCtor(ObjectGeneration obj, FileGeneration fg)
        {
            fg.AppendLine($"public {obj.Name}_Observable()");
            using (new BraceWrapper(fg))
            {
            }
            fg.AppendLine();

            fg.AppendLine($"public {obj.Name}_Observable(IObservable<string> streamSource)");
            using (new DepthWrapper(fg))
            {
                fg.AppendLine($": base(streamSource)");
            }
            using (new BraceWrapper(fg))
            {
                fg.AppendLine("Init();");
            }
            fg.AppendLine();
        }

        private static void AddUsings(FileGeneration fg)
        {
            fg.AppendLine("using Loqui;");
            fg.AppendLine("using Mutagen.Bethesda.Binary;");
            fg.AppendLine("using Mutagen.Bethesda.Oblivion.Internals;");
            fg.AppendLine("using Noggog;");
            fg.AppendLine("using System;");
            fg.AppendLine("using System.Collections.Generic;");
            fg.AppendLine("using System.Linq;");
            fg.AppendLine("using System.Reactive.Linq;");
            fg.AppendLine("using System.Threading.Tasks;");
            fg.AppendLine();
        }

        private async Task GenerateMembers(ObjectGeneration obj, FileGeneration fg)
        {
            foreach (var item in IterateLoqui(obj))
            {
                if (item.IsGroup)
                {
                    fg.AppendLine($"public IObservable<GroupObservable{item.Loqui.GenericTypes}> {item.Loqui.Name} {{ get; private set; }}");
                }
                else
                {
                    fg.AppendLine($"public IObservable<{item.Loqui.TypeName}> {item.Loqui.Name} {{ get; private set; }}");
                }
            }
            fg.AppendLine();
        }

        private async Task GenerateInit(ObjectGeneration obj, FileGeneration fg)
        {
            fg.AppendLine($"private void Init()");
            using (new BraceWrapper(fg))
            {
                foreach (var item in IterateLoqui(obj))
                {
                    if (item.IsGroup)
                    {
                        var grupTargetObj = item.Loqui.GetGroupTarget();
                        fg.AppendLine($"this.{item.Loqui.Name} = this.GetGroupObservable<{grupTargetObj.Name}>({grupTargetObj.RegistrationName}.{Mutagen.Bethesda.Constants.TRIGGERING_RECORDTYPE_MEMBER});");
                    }
                    else
                    {
                        fg.AppendLine($"this.{item.Loqui.Name} = this.GetObservableRecord<{item.Loqui.TargetObjectGeneration.Name}>({item.Loqui.TargetObjectGeneration.RegistrationName}.{Mutagen.Bethesda.Constants.TRIGGERING_RECORDTYPE_MEMBER});");
                    }
                }
            }
            fg.AppendLine();
        }

        private IEnumerable<(LoquiType Loqui, bool IsGroup)> IterateLoqui(ObjectGeneration obj)
        {
            foreach (var item in obj.IterateFields())
            {
                switch (item.Name)
                {
                    case "Cells":
                        yield break;
                    default:
                        break;
                }
                if (!(item is LoquiType loqui))
                {
                    throw new ArgumentException();
                }
                yield return (
                    loqui,
                    loqui.TargetObjectGeneration?.GetObjectType() == ObjectType.Group);
            }
        }

        private void GenerateDo(ObjectGeneration obj, FileGeneration fg)
        {
            fg.AppendLine($"public {obj.Name}_Observable Do(Action<MajorRecord> doAction)");
            using (new BraceWrapper(fg))
            {
                fg.AppendLine($"return new {obj.Name}_Observable()");
                using (new BraceWrapper(fg) { AppendSemicolon = true })
                {
                    foreach (var item in this.IterateLoqui(obj))
                    {
                        if (item.IsGroup)
                        {
                            fg.AppendLine($"{item.Loqui.Name} = this.{item.Loqui.Name}.Select((g) => g.Do(doAction)),");
                        }
                        else
                        {
                            fg.AppendLine($"{item.Loqui.Name} = this.{item.Loqui.Name},");
                        }
                    }
                }
            }
            fg.AppendLine();
        }

        private void GenerateWhere(ObjectGeneration obj, FileGeneration fg)
        {
            fg.AppendLine($"public {obj.Name}_Observable Where(Func<KeyValuePair<FormKey, IObservable<MajorRecord>>, bool> selector)");
            using (new BraceWrapper(fg))
            {
                fg.AppendLine($"return new {obj.Name}_Observable()");
                using (new BraceWrapper(fg) { AppendSemicolon = true })
                {
                    foreach (var item in this.IterateLoqui(obj))
                    {
                        if (item.IsGroup)
                        {
                            fg.AppendLine($"{item.Loqui.Name} = this.{item.Loqui.Name}.Select((g) => g.Where(selector)),");
                        }
                        else
                        {
                            fg.AppendLine($"{item.Loqui.Name} = this.{item.Loqui.Name},");
                        }
                    }
                }
            }
            fg.AppendLine();
        }

        private void GenerateWrite(ObjectGeneration obj, FileGeneration fg)
        {
            fg.AppendLine("public async Task Write_Binary(MutagenWriter writer)");
            using (new BraceWrapper(fg))
            {
                foreach (var item in this.IterateLoqui(obj))
                {
                    if (item.IsGroup)
                    {
                        fg.AppendLine($"await WriteGroup(writer, this.{item.Loqui.Name});");
                    }
                    else
                    {
                        fg.AppendLine($"(await this.{item.Loqui.Name}.LastAsync()).Write_Binary(writer);");
                    }
                }
            }
            fg.AppendLine();

            fg.AppendLine($"public async Task Write_Binary(string path)");
            using (new BraceWrapper(fg))
            {
                fg.AppendLine($"using (var writer = new MutagenWriter(path))");
                using (new BraceWrapper(fg))
                {
                    fg.AppendLine($"await Write_Binary(writer);");
                }
            }
            fg.AppendLine();
        }
    }
}
